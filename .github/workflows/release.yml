name: learn-github-actions
on: [push]

jobs:
  poc-deploy:
    name: check-bats-version
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Install Dependencies
        run: yarn

      - id: 'auth'
        uses: 'google-github-actions/auth@v0'
        with:
          workload_identity_provider: 'projects/855172212777/locations/global/workloadIdentityPools/my-pool/providers/my-provider'
          service_account: 'my-service-account@poc-deploy-app.iam.gserviceaccount.com'

      - id: 'secrets'
        uses: 'google-github-actions/get-secretmanager-secrets@v0'
        with:
          secrets: |-
            mysecret:poc-deploy-app/my-secret
            GOOGLE_PLAY_ACCESS_KEY:poc-deploy-app/my-secret

      - name: Setup env
        run: |
          echo "
          MY_SECRET='${{ steps.secrets.outputs.mysecret }}'
          " > .env

      - name: Show .env
        run: echo "$(<.env)"

      - name: Gradle clear build folder
        run: |
          cd android && sudo ./gradlew clean

      - name: Stop other Daemons
        run: |
          cd android && sudo ./gradlew --stop
      
      - name: Get Google Play JSON Key
        uses: jsdaniell/create-json@1.1.2
        with:
          name: 'google_play_access_key.json'
          json: '${{ steps.secrets.outputs.GOOGLE_PLAY_ACCESS_KEY }}'
          dir: '/android/'

      - name: Build Android Release APK
        run: |
          cd android && sudo ./gradlew assembleRelease

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '2.7.2'

      - name: Run distribute lane
        run: |
          cd android && \
          bundle install && \
          bundle exec fastlane distribute \
            build_path:/home/runner/work/poc-fastlane-deploy/poc-fastlane-deploy/android/app/build/outputs/apk/release/debug/app-release.apk
          

      
